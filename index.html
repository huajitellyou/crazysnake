<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级贪吃蛇游戏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 完整CSS样式（与之前相同） */
    </style>
</head>
<body>
    <!-- 完整HTML结构（与之前相同） -->
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 获取Canvas和上下文
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // 设置Canvas尺寸
            function resizeCanvas() {
                const size = Math.min(window.innerWidth * 0.9, 600);
                canvas.width = size;
                canvas.height = size;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 游戏变量
            const gridSize = 20;
            const tileCount = canvas.width / gridSize;
            let snake = [];
            let food = {};
            let score = 0;
            let velocityX = 0;
            let velocityY = 0;
            let gameLoop;
            let isPaused = false;
            let isGameRunning = false;
            let speed = 150; // 初始速度（毫秒）
            let baseSpeed = 150;
            let speedLevel = 5;
            let speedToggle = true;
            
            // 贴图变量
            let snakeHeadImg = null;
            let snakeBodyImg = null;
            let foodImg = null;
            
            // ==== 关键修复：蛇身绘制优化 ====
            function drawDefaultSnakeHead(x, y, width, height) {
                // 三角形头部（根据移动方向调整）
                ctx.fillStyle = '#2e8b57';
                ctx.beginPath();
                
                if (velocityX === 1) { // 向右
                    ctx.moveTo(x, y + height/2);
                    ctx.lineTo(x + width, y);
                    ctx.lineTo(x + width, y + height);
                } else if (velocityX === -1) { // 向左
                    ctx.moveTo(x + width, y + height/2);
                    ctx.lineTo(x, y);
                    ctx.lineTo(x, y + height);
                } else if (velocityY === 1) { // 向下
                    ctx.moveTo(x + width/2, y);
                    ctx.lineTo(x, y + height);
                    ctx.lineTo(x + width, y + height);
                } else { // 向上（默认）
                    ctx.moveTo(x + width/2, y + height);
                    ctx.lineTo(x, y);
                    ctx.lineTo(x + width, y);
                }
                
                ctx.closePath();
                ctx.fill();
                
                // 眼睛（根据方向调整位置）
                const eyeSize = width / 8;
                const eyeOffset = width / 4;
                if (velocityX === 1 || velocityX === -1) {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(x + width - eyeOffset*1.5, y + height/3, eyeSize, 0, Math.PI * 2);
                    ctx.arc(x + width - eyeOffset*1.5, y + 2*height/3, eyeSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(x + width - eyeOffset*1.5, y + height/3, eyeSize/1.5, 0, Math.PI * 2);
                    ctx.arc(x + width - eyeOffset*1.5, y + 2*height/3, eyeSize/1.5, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(x + width/3, y + height - eyeOffset*1.5, eyeSize, 0, Math.PI * 2);
                    ctx.arc(x + 2*width/3, y + height - eyeOffset*1.5, eyeSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(x + width/3, y + height - eyeOffset*1.5, eyeSize/1.5, 0, Math.PI * 2);
                    ctx.arc(x + 2*width/3, y + height - eyeOffset*1.5, eyeSize/1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            function drawDefaultSnakeBody(x, y, width, height, index, total) {
                // 渐变绿色身体（尾部稍窄）
                const sizeFactor = index < 3 ? 0.9 : 0.8 + (0.1 * (total - index)/3;
                const bodyWidth = width * sizeFactor;
                const bodyHeight = height * sizeFactor;
                const offsetX = (width - bodyWidth) / 2;
                const offsetY = (height - bodyHeight) / 2;
                
                ctx.fillStyle = `hsl(120, 70%, ${40 + 20*(index/total)}%)`;
                ctx.beginPath();
                ctx.roundRect(x + offsetX, y + offsetY, bodyWidth, bodyHeight, bodyWidth/4);
                ctx.fill();
                
                // 身体分节效果
                if (index > 0 && index < total - 1) {
                    ctx.fillStyle = '#1a5e37';
                    ctx.beginPath();
                    ctx.roundRect(
                        x + offsetX + bodyWidth/4, 
                        y + offsetY + bodyHeight/4, 
                        bodyWidth/2, 
                        bodyHeight/2, 
                        bodyWidth/8
                    );
                    ctx.fill();
                }
            }
            
            function drawDefaultFood(x, y, width, height) {
                // 苹果主体
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.ellipse(x + width/2, y + height/2, width/2, height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // 苹果叶子
                ctx.fillStyle = '#3cb371';
                ctx.beginPath();
                ctx.moveTo(x + width/2, y + height/4);
                ctx.lineTo(x + width/3, y + height/6);
                ctx.lineTo(x + width/2, y + height/3);
                ctx.fill();
                
                // 苹果柄
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x + width/2, y + height/4);
                ctx.lineTo(x + width/2, y);
                ctx.stroke();
            }
            // ==== 蛇身绘制优化结束 ====
            
            // 初始化游戏
            function initGame() {
                snake = [
                    {x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)}
                ];
                score = 0;
                velocityX = 0;
                velocityY = 0;
                speed = baseSpeed;
                speedLevel = 5;
                updateStats();
                
                generateFood();
                draw();
            }
            
            // 生成食物
            function generateFood() {
                food = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
                
                // 确保食物不会出现在蛇身上
                for (let segment of snake) {
                    if (segment.x === food.x && segment.y === food.y) {
                        return generateFood();
                    }
                }
            }
            
            // 游戏主循环
            function game() {
                if (isPaused || !isGameRunning) return;
                
                // 移动蛇
                const head = {x: snake[0].x + velocityX, y: snake[0].y + velocityY};
                snake.unshift(head);
                
                // 检查是否吃到食物
                if (head.x === food.x && head.y === food.y) {
                    score += 10;
                    
                    // 如果开启了加速模式
                    if (speedToggle && speed > 60) {
                        speed -= 5;
                        speedLevel = Math.max(1, Math.floor((baseSpeed - speed) / 18) + 1);
                    }
                    
                    generateFood();
                } else {
                    snake.pop();
                }
                
                // 检查碰撞
                if (
                    head.x < 0 || head.x >= tileCount || 
                    head.y < 0 || head.y >= tileCount ||
                    checkSelfCollision()
                ) {
                    gameOver();
                    return;
                }
                
                // 绘制游戏
                draw();
                
                // 继续游戏循环
                gameLoop = setTimeout(game, speed);
            }
            
            // 检查蛇是否撞到自己
            function checkSelfCollision() {
                const head = snake[0];
                for (let i = 1; i < snake.length; i++) {
                    if (snake[i].x === head.x && snake[i].y === head.y) {
                        return true;
                    }
                }
                return false;
            }
            
            // 绘制游戏
            function draw() {
                // 清空画布
                ctx.fillStyle = 'rgba(0, 20, 40, 0.9)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制网格
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.lineWidth = 0.5;
                for (let i = 0; i < tileCount; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * gridSize, 0);
                    ctx.lineTo(i * gridSize, canvas.height);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(0, i * gridSize);
                    ctx.lineTo(canvas.width, i * gridSize);
                    ctx.stroke();
                }
                
                // 绘制食物
                if (foodImg) {
                    ctx.drawImage(foodImg, food.x * gridSize, food.y * gridSize, gridSize, gridSize);
                } else {
                    drawDefaultFood(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
                }
                
                // 绘制蛇 - 从尾部到头部（确保头部在顶部）
                for (let i = snake.length - 1; i >= 0; i--) {
                    // 头部使用完整格子大小，身体稍小，尾部最小
                    const isHead = (i === 0);
                    const isTail = (i >= snake.length - 3);
                    
                    let segmentWidth, segmentHeight;
                    if (isHead) {
                        segmentWidth = gridSize;
                        segmentHeight = gridSize;
                    } else if (isTail) {
                        const tailIndex = snake.length - i - 1;
                        segmentWidth = gridSize * (0.9 - tailIndex * 0.1);
                        segmentHeight = gridSize * (0.9 - tailIndex * 0.1);
                    } else {
                        segmentWidth = gridSize * 0.85;
                        segmentHeight = gridSize * 0.85;
                    }
                    
                    const offsetX = (gridSize - segmentWidth) / 2;
                    const offsetY = (gridSize - segmentHeight) / 2;
                    
                    if (isHead) {
                        if (snakeHeadImg) {
                            ctx.drawImage(
                                snakeHeadImg, 
                                snake[i].x * gridSize + offsetX, 
                                snake[i].y * gridSize + offsetY, 
                                segmentWidth, 
                                segmentHeight
                            );
                        } else {
                            drawDefaultSnakeHead(
                                snake[i].x * gridSize + offsetX, 
                                snake[i].y * gridSize + offsetY, 
                                segmentWidth, 
                                segmentHeight
                            );
                        }
                    } else {
                        if (snakeBodyImg) {
                            ctx.drawImage(
                                snakeBodyImg, 
                                snake[i].x * gridSize + offsetX, 
                                snake[i].y * gridSize + offsetY, 
                                segmentWidth, 
                                segmentHeight
                            );
                        } else {
                            drawDefaultSnakeBody(
                                snake[i].x * gridSize + offsetX, 
                                snake[i].y * gridSize + offsetY, 
                                segmentWidth, 
                                segmentHeight,
                                i,
                                snake.length
                            );
                        }
                    }
                }
                
                updateStats();
            }
            
            // 更新统计信息
            function updateStats() {
                document.getElementById('score').textContent = score;
                document.getElementById('length').textContent = snake.length;
                document.getElementById('speed').textContent = speedLevel;
            }
            
            // 游戏结束
            function gameOver() {
                clearTimeout(gameLoop);
                isGameRunning = false;
                document.getElementById('finalScore').textContent = score;
                document.getElementById('gameOver').style.display = 'flex';
            }
            
            // 键盘控制
            document.addEventListener('keydown', (e) => {
                if (!isGameRunning) return;
                
                switch(e.key) {
                    case 'ArrowUp':
                        if (velocityY !== 1) {
                            velocityX = 0;
                            velocityY = -1;
                        }
                        break;
                    case 'ArrowDown':
                        if (velocityY !== -1) {
                            velocityX = 0;
                            velocityY = 1;
                        }
                        break;
                    case 'ArrowLeft':
                        if (velocityX !== 1) {
                            velocityX = -1;
                            velocityY = 0;
                        }
                        break;
                    case 'ArrowRight':
                        if (velocityX !== -1) {
                            velocityX = 1;
                            velocityY = 0;
                        }
                        break;
                }
            });
            
            // 移动端控制
            document.getElementById('upBtn').addEventListener('click', () => {
                if (velocityY !== 1 && isGameRunning) {
                    velocityX = 0;
                    velocityY = -1;
                }
            });
            
            document.getElementById('downBtn').addEventListener('click', () => {
                if (velocityY !== -1 && isGameRunning) {
                    velocityX = 0;
                    velocityY = 1;
                }
            });
            
            document.getElementById('leftBtn').addEventListener('click', () => {
                if (velocityX !== 1 && isGameRunning) {
                    velocityX = -1;
                    velocityY = 0;
                }
            });
            
            document.getElementById('rightBtn').addEventListener('click', () => {
                if (velocityX !== -1 && isGameRunning) {
                    velocityX = 1;
                    velocityY = 0;
                }
            });
            
            // 游戏控制按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                if (!isGameRunning) {
                    isGameRunning = true;
                    isPaused = false;
                    if (snake.length <= 1) {
                        initGame();
                    }
                    game();
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                if (isGameRunning) {
                    isPaused = !isPaused;
                    document.getElementById('pauseBtn').innerHTML = isPaused ? 
                        '<i class="fas fa-play"></i> 继续' : 
                        '<i class="fas fa-pause"></i> 暂停';
                    
                    if (!isPaused) {
                        game();
                    }
                }
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                clearTimeout(gameLoop);
                isGameRunning = false;
                isPaused = false;
                initGame();
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> 暂停';
            });
            
            document.getElementById('restartBtn').addEventListener('click', () => {
                document.getElementById('gameOver').style.display = 'none';
                initGame();
                isGameRunning = true;
                isPaused = false;
                game();
            });
            
            // 速度开关
            document.getElementById('speedToggle').addEventListener('change', (e) => {
                speedToggle = e.target.checked;
            });
            
            // 图片上传处理
            function handleImageUpload(event, previewId) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            if (previewId === 'snakeHeadPreview') {
                                snakeHeadImg = img;
                            } else if (previewId === 'snakeBodyPreview') {
                                snakeBodyImg = img;
                            } else if (previewId === 'foodPreview') {
                                foodImg = img;
                            }
                            
                            const preview = document.getElementById(previewId);
                            preview.innerHTML = '';
                            const previewImg = document.createElement('img');
                            previewImg.src = e.target.result;
                            preview.appendChild(previewImg);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            document.getElementById('snakeHeadUpload').addEventListener('change', (e) => {
                handleImageUpload(e, 'snakeHeadPreview');
            });
            
            document.getElementById('snakeBodyUpload').addEventListener('change', (e) => {
                handleImageUpload(e, 'snakeBodyPreview');
            });
            
            document.getElementById('foodUpload').addEventListener('change', (e) => {
                handleImageUpload(e, 'foodPreview');
            });
            
            // 初始化游戏
            initGame();
        });
    </script>
</body>
</html>
