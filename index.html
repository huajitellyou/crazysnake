<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë¥™ÂêÉËõáÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            color: white;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 12px;
            width: 100%;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .score-board {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .score-item {
            text-align: center;
        }

        .score-item .label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .score-item .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .game-area {
            position: relative;
            width: 100%;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            background: #2c3e50;
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .action-btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }

        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            width: 150px;
            height: 150px;
        }

        .mobile-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .mobile-btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }

        .up-btn { grid-column: 2; grid-row: 1; }
        .left-btn { grid-column: 1; grid-row: 2; }
        .right-btn { grid-column: 3; grid-row: 2; }
        .down-btn { grid-column: 2; grid-row: 3; }

        .center-btn { grid-column: 2; grid-row: 2; background: rgba(255,255,255,0.1) !important; }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .settings-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 500;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .game-over h2 {
            margin-bottom: 15px;
            color: #FF6B6B;
        }

        .background-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .speed-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .speed-control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type="range"] {
            width: 120px;
        }

        .settings-tip {
            position: absolute;
            top: -10px;
            right: 60px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }

        .settings-tip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -10px;
            transform: translateY(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent transparent rgba(255, 255, 255, 0.9);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 500px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .score-board {
                padding: 10px;
            }
            
            .score-item .value {
                font-size: 1.1em;
            }
            
            .mobile-controls {
                width: 140px;
                height: 140px;
            }
            
            .action-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>üêç Ë¥™ÂêÉËõáÊ∏∏Êàè</h1>
        </div>

        <div class="score-board">
            <div class="score-item">
                <div class="label">ÂæóÂàÜ</div>
                <div class="value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="label">ÈÄüÂ∫¶</div>
                <div class="value" id="speed">1</div>
            </div>
            <div class="score-item">
                <div class="label">ÈïøÂ∫¶</div>
                <div class="value" id="length">1</div>
            </div>
        </div>

        <div class="game-area">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div class="game-over" id="gameOver">
                <h2>Ê∏∏ÊàèÁªìÊùü!</h2>
                <p>ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></p>
                <button onclick="restartGame()" style="margin-top: 15px; padding: 10px; width: 100%;">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>
        </div>

        <div class="controls-container">
            <div class="action-buttons">
                <button class="action-btn" onclick="startGame()" title="ÂºÄÂßãÊ∏∏Êàè">‚ñ∂Ô∏è</button>
                <button class="action-btn" onclick="pauseGame()" title="ÊöÇÂÅú">‚è∏Ô∏è</button>
            </div>

            <div class="mobile-controls">
                <div class="mobile-btn up-btn" ontouchstart="changeDirection('UP')" ontouchend="event.preventDefault()">‚Üë</div>
                <div class="mobile-btn left-btn" ontouchstart="changeDirection('LEFT')" ontouchend="event.preventDefault()">‚Üê</div>
                <div class="mobile-btn center-btn" style="pointer-events: none;"></div>
                <div class="mobile-btn right-btn" ontouchstart="changeDirection('RIGHT')" ontouchend="event.preventDefault()">‚Üí</div>
                <div class="mobile-btn down-btn" ontouchstart="changeDirection('DOWN')" ontouchend="event.preventDefault()">‚Üì</div>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="restartGame()" title="ÈáçÊñ∞ÂºÄÂßã">üîÑ</button>
                <button class="action-btn" onclick="openSettings()" title="ËÆæÁΩÆ" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>Ê∏∏ÊàèËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div class="background-controls">
                <div class="color-picker">
                    <span>ÁΩëÈ°µËÉåÊôØ:</span>
                    <input type="color" id="pageBackgroundColor" value="#667eea" onchange="changePageBackgroundColor()">
                </div>
                <div class="color-picker">
                    <span>Ê∏∏ÊàèËÉåÊôØ:</span>
                    <input type="color" id="gameBackgroundColor" value="#2c3e50" onchange="changeGameBackgroundColor()">
                </div>
                <div class="control-row">
                    <span>ÂêÉÂà∞È£üÁâ©ÂêéÂä†ÈÄü</span>
                    <label class="switch">
                        <input type="checkbox" id="speedUpToggle" onchange="toggleSpeedUp()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="speed-controls">
                    <div class="speed-control-item">
                        <span>ÂàùÂßãÈÄüÂ∫¶:</span>
                        <input type="range" id="initialSpeed" min="0.5" max="3" step="0.1" value="1" onchange="updateInitialSpeed()">
                        <span id="initialSpeedValue">1.0</span>
                    </div>
                    <div class="speed-control-item">
                        <span>Âä†ÈÄüÂ∫¶:</span>
                        <input type="range" id="acceleration" min="0.05" max="0.5" step="0.05" value="0.1" onchange="updateAcceleration()">
                        <span id="accelerationValue">0.10</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SnakeGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gridSize = 20;
                this.canvas.width = Math.floor(this.canvas.width / this.gridSize) * this.gridSize;
                this.canvas.height = Math.floor(this.canvas.height / this.gridSize) * this.gridSize;
                
                // Ê∏∏ÊàèÁä∂ÊÄÅ
                this.snake = [];
                this.food = {};
                this.direction = 'RIGHT';
                this.nextDirection = 'RIGHT';
                this.score = 0;
                this.speed = 1;
                this.gameRunning = false;
                this.gameLoopId = null;
                this.speedUp = false; // ÈªòËÆ§ÂÖ≥Èó≠Âä†ÈÄüÊ®°Âºè
                this.gameOverFlag = false;
                this.started = false;
                
                // ÈÄüÂ∫¶ËÆæÁΩÆ
                this.initialSpeed = 1;
                this.acceleration = 0.1; // ÈªòËÆ§Âä†ÈÄüÂ∫¶ÊîπÂ∞è
                
                // ËÉåÊôØËÆæÁΩÆ
                this.pageBackgroundColor = '#667eea';
                this.gameBackgroundColor = '#2c3e50';
                
                // È°µÈù¢ÂèØËßÅÊÄß
                this.isVisible = true;
                this.isFocused = true;
                
                // ÂõæÁâáËµÑÊ∫ê
                this.headImage = this.createDefaultHead();
                this.foodImage = this.createDefaultFood();
                
                this.init();
            }
            
            init() {
                this.resetGame();
                this.draw();
                this.setupEventListeners();
                this.setupVisibilityListeners();
            }
            
            setupVisibilityListeners() {
                // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
                document.addEventListener('visibilitychange', () => {
                    this.isVisible = !document.hidden;
                    this.handleVisibilityChange();
                });
                
                // Á™óÂè£ÁÑ¶ÁÇπÂèòÂåñ
                window.addEventListener('focus', () => {
                    this.isFocused = true;
                    this.handleVisibilityChange();
                });
                
                window.addEventListener('blur', () => {
                    this.isFocused = false;
                    this.handleVisibilityChange();
                });
            }
            
            handleVisibilityChange() {
                if (this.gameRunning) {
                    if (this.isVisible && this.isFocused) {
                        // È°µÈù¢ÂèØËßÅ‰∏îÊúâÁÑ¶ÁÇπÊó∂ÊÅ¢Â§çÊ∏∏Êàè
                        this.resumeGame();
                    } else {
                        // È°µÈù¢‰∏çÂèØËßÅÊàñÂ§±ÂéªÁÑ¶ÁÇπÊó∂ÊöÇÂÅúÊ∏∏Êàè
                        this.pauseGameInternally();
                    }
                }
            }
            
            createDefaultHead() {
                const canvas = document.createElement('canvas');
                canvas.width = this.gridSize;
                canvas.height = this.gridSize;
                const ctx = canvas.getContext('2d');
                
                // ËõáÂ§¥ - ÁªøËâ≤Ê∏êÂèò
                const gradient = ctx.createLinearGradient(0, 0, this.gridSize, this.gridSize);
                gradient.addColorStop(0, '#4CAF50');
                gradient.addColorStop(1, '#2E7D32');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(0, 0, this.gridSize, this.gridSize, 8);
                ctx.fill();
                
                // ÁúºÁùõ
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(this.gridSize - 6, 6, 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.gridSize - 6, 6, 1, 0, Math.PI * 2);
                ctx.fill();
                
                return canvas;
            }
            
            createDefaultFood() {
                const canvas = document.createElement('canvas');
                canvas.width = this.gridSize;
                canvas.height = this.gridSize;
                const ctx = canvas.getContext('2d');
                
                // ËãπÊûúÂΩ¢Áä∂
                ctx.fillStyle = '#FF5252';
                ctx.beginPath();
                ctx.arc(this.gridSize/2, this.gridSize/2, this.gridSize/2 - 2, 0, Math.PI * 2);
                ctx.fill();
                
                // È´òÂÖâ
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(this.gridSize/3, this.gridSize/3, this.gridSize/6, 0, Math.PI * 2);
                ctx.fill();
                
                // Ëåé
                ctx.fillStyle = '#7CB342';
                ctx.fillRect(this.gridSize/2 - 1, 2, 2, 4);
                
                return canvas;
            }
            
            // Êâ©Â±ï CanvasRenderingContext2D ‰ª•ÊîØÊåÅ roundRect
            roundRect(ctx, x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.arcTo(x + width, y, x + width, y + height, radius);
                ctx.arcTo(x + width, y + height, x, y + height, radius);
                ctx.arcTo(x, y + height, x, y, radius);
                ctx.arcTo(x, y, x + width, y, radius);
                ctx.closePath();
                return ctx;
            }
            
            resetGame() {
                this.snake = [
                    {x: 5, y: 10},
                    {x: 4, y: 10},
                    {x: 3, y: 10}
                ];
                this.direction = 'RIGHT';
                this.nextDirection = 'RIGHT';
                this.score = 0;
                this.speed = this.initialSpeed;
                this.gameOverFlag = false;
                this.started = false;
                this.generateFood();
                this.updateUI();
                document.getElementById('gameOver').style.display = 'none';
                this.draw();
            }
            
            generateFood() {
                const maxX = Math.floor(this.canvas.width / this.gridSize) - 1;
                const maxY = Math.floor(this.canvas.height / this.gridSize) - 1;
                
                let newFood;
                let foodOnSnake;
                
                do {
                    foodOnSnake = false;
                    newFood = {
                        x: Math.floor(Math.random() * maxX),
                        y: Math.floor(Math.random() * maxY)
                    };
                    
                    for (let segment of this.snake) {
                        if (segment.x === newFood.x && segment.y === newFood.y) {
                            foodOnSnake = true;
                            break;
                        }
                    }
                } while (foodOnSnake);
                
                this.food = newFood;
            }
            
            move() {
                if (this.gameOverFlag || !this.started) return;
                
                this.direction = this.nextDirection;
                
                const head = {...this.snake[0]};
                
                switch (this.direction) {
                    case 'UP': head.y -= 1; break;
                    case 'DOWN': head.y += 1; break;
                    case 'LEFT': head.x -= 1; break;
                    case 'RIGHT': head.x += 1; break;
                }
                
                // ËæπÁïåÊ£ÄÊü•
                if (head.x < 0 || head.x >= this.canvas.width / this.gridSize || 
                    head.y < 0 || head.y >= this.canvas.height / this.gridSize) {
                    this.gameOver();
                    return;
                }
                
                // Ëá™ÊàëÁ¢∞ÊíûÊ£ÄÊü•
                for (let i = 0; i < this.snake.length; i++) {
                    if (this.snake[i].x === head.x && this.snake[i].y === head.y) {
                        this.gameOver();
                        return;
                    }
                }
                
                this.snake.unshift(head);
                
                // ÂêÉÈ£üÁâ©Ê£ÄÊü•
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    if (this.speedUp) {
                        this.speed += this.acceleration;
                    }
                    this.generateFood();
                    this.updateUI();
                } else {
                    this.snake.pop();
                }
            }
            
            drawSnake() {
                if (this.snake.length === 0) return;
                
                // ÁªòÂà∂ËõáË∫´ÔºàËøûË¥ØÁöÑÔºâ
                for (let i = 1; i < this.snake.length; i++) {
                    const segment = this.snake[i];
                    const prevSegment = this.snake[i-1];
                    
                    // ËÆ°ÁÆóËøûÊé•ÁÇπ
                    const centerX = segment.x * this.gridSize + this.gridSize/2;
                    const centerY = segment.y * this.gridSize + this.gridSize/2;
                    const prevCenterX = prevSegment.x * this.gridSize + this.gridSize/2;
                    const prevCenterY = prevSegment.y * this.gridSize + this.gridSize/2;
                    
                    // ÁªòÂà∂ËøûÊé•ÈÉ®ÂàÜ
                    this.ctx.fillStyle = '#4CAF50';
                    this.ctx.beginPath();
                    
                    // Ê†πÊçÆÊñπÂêëÁªòÂà∂Ê§≠ÂúÜÂΩ¢ËøûÊé•
                    if (Math.abs(segment.x - prevSegment.x) > 0) {
                        // Ê∞¥Âπ≥ËøûÊé•
                        const width = this.gridSize * 1.2;
                        const height = this.gridSize * 0.8;
                        this.ctx.ellipse(
                            (centerX + prevCenterX) / 2,
                            (centerY + prevCenterY) / 2,
                            width/2,
                            height/2,
                            0,
                            0,
                            Math.PI * 2
                        );
                    } else {
                        // ÂûÇÁõ¥ËøûÊé•
                        const width = this.gridSize * 0.8;
                        const height = this.gridSize * 1.2;
                        this.ctx.ellipse(
                            (centerX + prevCenterX) / 2,
                            (centerY + prevCenterY) / 2,
                            width/2,
                            height/2,
                            0,
                            0,
                            Math.PI * 2
                        );
                    }
                    this.ctx.fill();
                    
                    // ÁªòÂà∂ÂΩìÂâçËäÇÊÆµ
                    const isTail = (i === this.snake.length - 1);
                    const size = isTail ? this.gridSize * 0.7 : this.gridSize;
                    const offset = isTail ? (this.gridSize - size) / 2 : 0;
                    
                    this.ctx.fillStyle = '#4CAF50';
                    this.roundRect(
                        this.ctx,
                        segment.x * this.gridSize + offset,
                        segment.y * this.gridSize + offset,
                        size,
                        size,
                        isTail ? 4 : 6
                    );
                    this.ctx.fill();
                }
                
                // ÁªòÂà∂ËõáÂ§¥
                const head = this.snake[0];
                this.ctx.drawImage(
                    this.headImage,
                    head.x * this.gridSize,
                    head.y * this.gridSize,
                    this.gridSize,
                    this.gridSize
                );
            }
            
            draw() {
                // ÁªòÂà∂ËÉåÊôØ
                this.ctx.fillStyle = this.gameBackgroundColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ÁªòÂà∂ÁΩëÊ†º
                this.ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                this.ctx.lineWidth = 0.5;
                for (let i = 0; i <= this.canvas.width; i += this.gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(i, 0);
                    this.ctx.lineTo(i, this.canvas.height);
                    this.ctx.stroke();
                }
                for (let i = 0; i <= this.canvas.height; i += this.gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, i);
                    this.ctx.lineTo(this.canvas.width, i);
                    this.ctx.stroke();
                }
                
                // ÁªòÂà∂È£üÁâ©
                this.ctx.drawImage(
                    this.foodImage,
                    this.food.x * this.gridSize,
                    this.food.y * this.gridSize,
                    this.gridSize,
                    this.gridSize
                );
                
                // ÁªòÂà∂Ëõá
                this.drawSnake();
            }
            
            updateUI() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('speed').textContent = this.speed.toFixed(1);
                document.getElementById('length').textContent = this.snake.length;
            }
            
            gameOver() {
                if (this.gameOverFlag) return;
                this.gameOverFlag = true;
                this.stopGameLoop();
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOver').style.display = 'block';
            }
            
            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    if (this.gameOverFlag) return;
                    switch(e.key) {
                        case 'ArrowUp':
                            if (this.direction !== 'DOWN') this.nextDirection = 'UP';
                            e.preventDefault();
                            this.startIfNotStarted();
                            break;
                        case 'ArrowDown':
                            if (this.direction !== 'UP') this.nextDirection = 'DOWN';
                            e.preventDefault();
                            this.startIfNotStarted();
                            break;
                        case 'ArrowLeft':
                            if (this.direction !== 'RIGHT') this.nextDirection = 'LEFT';
                            e.preventDefault();
                            this.startIfNotStarted();
                            break;
                        case 'ArrowRight':
                            if (this.direction !== 'LEFT') this.nextDirection = 'RIGHT';
                            e.preventDefault();
                            this.startIfNotStarted();
                            break;
                    }
                });
                
                // ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂
                let touchStartX = 0;
                let touchStartY = 0;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    e.preventDefault();
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                });
                
                this.canvas.addEventListener('touchend', (e) => {
                    if (!touchStartX || !touchStartY || this.gameOverFlag) return;
                    
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    
                    const dx = touchEndX - touchStartX;
                    const dy = touchEndY - touchStartY;
                    
                    if (Math.abs(dx) > Math.abs(dy)) {
                        if (dx > 0 && this.direction !== 'LEFT') {
                            this.nextDirection = 'RIGHT';
                        } else if (dx < 0 && this.direction !== 'RIGHT') {
                            this.nextDirection = 'LEFT';
                        }
                    } else {
                        if (dy > 0 && this.direction !== 'UP') {
                            this.nextDirection = 'DOWN';
                        } else if (dy < 0 && this.direction !== 'DOWN') {
                            this.nextDirection = 'UP';
                        }
                    }
                    
                    this.startIfNotStarted();
                    touchStartX = 0;
                    touchStartY = 0;
                    e.preventDefault();
                });
            }
            
            startIfNotStarted() {
                if (!this.started) {
                    this.started = true;
                    if (!this.gameRunning) {
                        this.start();
                    }
                }
            }
            
            // Ê†∏ÂøÉÊ∏∏ÊàèÂæ™ÁéØÊéßÂà∂ÊñπÊ≥ï
            start() {
                if (this.gameRunning) return;
                if (this.gameOverFlag) {
                    this.resetGame();
                }
                
                this.gameRunning = true;
                document.getElementById('gameOver').style.display = 'none';
                this.startGameLoop();
            }
            
            pause() {
                this.gameRunning = !this.gameRunning;
                if (this.gameRunning) {
                    this.startGameLoop();
                } else {
                    this.stopGameLoop();
                }
            }
            
            // ÂÜÖÈÉ®ÊöÇÂÅúÔºàÁî®‰∫éÈ°µÈù¢‰∏çÂèØËßÅÊó∂Ôºâ
            pauseGameInternally() {
                if (this.gameRunning) {
                    this.stopGameLoop();
                }
            }
            
            // ÊÅ¢Â§çÊ∏∏ÊàèÔºàÁî®‰∫éÈ°µÈù¢ÈáçÊñ∞ÂèØËßÅÊó∂Ôºâ
            resumeGame() {
                if (this.gameRunning) {
                    this.startGameLoop();
                }
            }
            
            startGameLoop() {
                // Á°Æ‰øùÂÅúÊ≠¢‰ªª‰ΩïÁé∞ÊúâÁöÑÂæ™ÁéØ
                this.stopGameLoop();
                
                // ÂêØÂä®Êñ∞ÁöÑÊ∏∏ÊàèÂæ™ÁéØ
                const gameStep = () => {
                    this.move();
                    this.draw();
                    if (this.gameRunning) {
                        this.gameLoopId = setTimeout(gameStep, 150 / this.speed);
                    }
                };
                
                this.gameLoopId = setTimeout(gameStep, 150 / this.speed);
            }
            
            stopGameLoop() {
                if (this.gameLoopId) {
                    clearTimeout(this.gameLoopId);
                    this.gameLoopId = null;
                }
            }
        }
        
        // ÂÖ®Â±ÄÊ∏∏ÊàèÂÆû‰æã
        let game = new SnakeGame();
        
        // ÊéßÂà∂ÂáΩÊï∞
        function startGame() {
            game.start();
        }
        
        function pauseGame() {
            game.pause();
        }
        
        function restartGame() {
            game.resetGame();
        }
        
        function changeDirection(direction) {
            if (game.gameOverFlag) return;
            switch(direction) {
                case 'UP':
                    if (game.direction !== 'DOWN') game.nextDirection = 'UP';
                    break;
                case 'DOWN':
                    if (game.direction !== 'UP') game.nextDirection = 'DOWN';
                    break;
                case 'LEFT':
                    if (game.direction !== 'RIGHT') game.nextDirection = 'LEFT';
                    break;
                case 'RIGHT':
                    if (game.direction !== 'LEFT') game.nextDirection = 'RIGHT';
                    break;
            }
            game.startIfNotStarted();
        }
        
        // ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            // ÁßªÈô§ÊèêÁ§∫
            const tip = document.querySelector('.settings-tip');
            if (tip) {
                tip.remove();
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        // ËÉåÊôØËÆæÁΩÆ
        function changePageBackgroundColor() {
            const color = document.getElementById('pageBackgroundColor').value;
            game.pageBackgroundColor = color;
            document.body.style.background = `linear-gradient(135deg, ${color} 0%, ${darkenColor(color, 30)} 100%)`;
        }
        
        function changeGameBackgroundColor() {
            const color = document.getElementById('gameBackgroundColor').value;
            game.gameBackgroundColor = color;
            game.draw();
        }
        
        function toggleSpeedUp() {
            game.speedUp = document.getElementById('speedUpToggle').checked;
        }
        
        // ÈÄüÂ∫¶ËÆæÁΩÆ
        function updateInitialSpeed() {
            const speed = parseFloat(document.getElementById('initialSpeed').value);
            document.getElementById('initialSpeedValue').textContent = speed.toFixed(1);
            game.initialSpeed = speed;
        }
        
        function updateAcceleration() {
            const acceleration = parseFloat(document.getElementById('acceleration').value);
            document.getElementById('accelerationValue').textContent = acceleration.toFixed(2);
            game.acceleration = acceleration;
        }
        
        // È¢úËâ≤Â§ÑÁêÜÂáΩÊï∞
        function darkenColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);
            
            R = Math.floor(R * (100 - percent) / 100);
            G = Math.floor(G * (100 - percent) / 100);
            B = Math.floor(B * (100 - percent) / 100);
            
            return "#" + 
                (R < 16 ? "0" : "") + R.toString(16) +
                (G < 16 ? "0" : "") + G.toString(16) +
                (B < 16 ? "0" : "") + B.toString(16);
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
        
        // Ê∑ªÂä†Ê§≠ÂúÜÁªòÂà∂ÊñπÊ≥ïÂà∞ CanvasRenderingContext2D
        if (CanvasRenderingContext2D.prototype.ellipse === undefined) {
            CanvasRenderingContext2D.prototype.ellipse = function(x, y, radiusX, radiusY, rotation, startAngle, endAngle, anticlockwise) {
                this.save();
                this.translate(x, y);
                this.rotate(rotation);
                this.scale(radiusX, radiusY);
                this.arc(0, 0, 1, startAngle, endAngle, anticlockwise);
                this.restore();
            };
        }
        
        // Ê∑ªÂä† roundRect ÊñπÊ≥ïÂà∞ CanvasRenderingContext2D
        if (CanvasRenderingContext2D.prototype.roundRect === undefined) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            };
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫ËÆæÁΩÆÊèêÁ§∫
        window.addEventListener('load', function() {
            // ÂàõÂª∫ËÆæÁΩÆÊèêÁ§∫
            setTimeout(() => {
                const tip = document.createElement('div');
                tip.className = 'settings-tip';
                tip.textContent = 'ÂèØ‰ª•Âú®ËøôÈáåÂºÄÂêØÂä†ÈÄüÊ®°Âºè';
                tip.style.position = 'absolute';
                tip.style.top = '-10px';
                tip.style.right = '60px';
                
                const settingsBtn = document.getElementById('settingsBtn');
                const btnRect = settingsBtn.getBoundingClientRect();
                const containerRect = settingsBtn.parentElement.getBoundingClientRect();
                
                tip.style.top = (btnRect.top - containerRect.top - 40) + 'px';
                tip.style.right = (containerRect.right - btnRect.right) + 'px';
                
                settingsBtn.parentElement.style.position = 'relative';
                settingsBtn.parentElement.appendChild(tip);
                
                // 3ÁßíÂêéËá™Âä®ÁßªÈô§ÊèêÁ§∫
                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 3000);
            }, 1000);
        });
    </script>
</body>
    </html>
